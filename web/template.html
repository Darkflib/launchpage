<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astro API Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #6b8cbc;
            --accent: #ff9e6d;
            --dark: #2c3e50;
            --light: #f8f9fa;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 2.2rem;
            color: var(--accent);
        }

        .logo h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(to right, #ff9e6d, #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .health-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            font-weight: 600;
        }

        .health-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 25px;
            color: var(--dark);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .sun-card .card-icon {
            background: linear-gradient(135deg, #ffd700, #ff9e6d);
            color: white;
        }

        .moon-card .card-icon {
            background: linear-gradient(135deg, #4a6fa5, #2c3e50);
            color: white;
        }

        .time-card .card-icon {
            background: linear-gradient(135deg, #6b8cbc, #4a6fa5);
            color: white;
        }

        .location-card .card-icon {
            background: linear-gradient(135deg, #ff9e6d, #ffd700);
            color: white;
        }

        .card-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 600px) {
            .card-content {
                grid-template-columns: 1fr;
            }
        }

        .info-item {
            margin-bottom: 15px;
        }

        .info-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }

        .info-value.large {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .info-value.moon-phase {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .info-value.illumination {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .illumination-bar {
            height: 8px;
            width: 100px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .illumination-fill {
            height: 100%;
            background: linear-gradient(to right, #4a6fa5, #ff9e6d);
            border-radius: 4px;
        }

        .sun-timeline {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 15px;
        }

        @media (max-width: 700px) {
            .sun-timeline {
                grid-template-columns: 1fr;
            }
        }

        .time-group {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .time-group:hover {
            background: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .time-group-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .time-group-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .time-group-icon.sunrise-icon {
            background: linear-gradient(135deg, #ff9e6d 0%, #ffd700 100%);
            color: white;
        }

        .time-group-icon.sunset-icon {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff9e6d 100%);
            color: white;
        }

        .time-group-icon.info-icon {
            background: linear-gradient(135deg, #4a6fa5 0%, #6b8cbc 100%);
            color: white;
        }

        .time-group-title {
            flex: 1;
        }

        .time-primary {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 2px;
        }

        .time-value {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--primary);
        }

        .time-secondary {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
        }

        .time-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .time-detail:last-child {
            margin-bottom: 0;
        }

        .time-detail-label {
            color: #6c757d;
            font-weight: 500;
        }

        .time-detail-value {
            color: var(--dark);
            font-weight: 600;
        }

        .timezone-badge {
            display: inline-block;
            background: rgba(74, 111, 165, 0.1);
            color: var(--primary);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 6px;
        }

        .sun-arc-container {
            margin: 20px 0 25px 0;
            padding: 20px;
            background: linear-gradient(180deg, #e3f2fd 0%, #f5f5f5 50%, #f0ead6 100%);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .sun-arc-container::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(240, 234, 214, 0) 0%, rgba(205, 186, 150, 0.15) 100%);
            border-radius: 0 0 12px 12px;
        }

        .sun-arc-svg {
            width: 100%;
            height: 180px;
            display: block;
        }

        .horizon-line {
            stroke: #8b4513;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
            opacity: 0.6;
        }

        .sun-path {
            fill: none;
            stroke: #ff9e6d;
            stroke-width: 3;
            stroke-dasharray: 8, 4;
            opacity: 0.8;
        }

        .sun-position {
            filter: drop-shadow(0 0 8px rgba(255, 193, 7, 0.8));
            transition: all 0.5s ease;
        }

        .sun-position circle {
            fill: #ffd700;
            stroke: #ff9e6d;
            stroke-width: 3;
        }

        .time-marker {
            font-size: 11px;
            fill: #495057;
            font-weight: 600;
        }

        .time-marker-line {
            stroke: #495057;
            stroke-width: 1;
            opacity: 0.4;
        }

        .sun-arc-legend {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #495057;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-item i {
            font-size: 1rem;
        }

        .moon-phase-visual {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .moon-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(90deg, #2c3e50 50%, #f8f9fa 50%);
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .moon-overlay {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            background: #f8f9fa;
            border-radius: 50%;
        }

        .moon-overlay.left {
            left: 0;
        }

        .moon-overlay.right {
            right: 0;
        }

        .day-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 5px;
        }

        .day-indicator.day {
            background: rgba(40, 167, 69, 0.15);
            color: var(--success);
        }

        .day-indicator.night {
            background: rgba(44, 62, 80, 0.15);
            color: var(--dark);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--light);
        }

        .input-group input, .input-group select {
            padding: 12px 15px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--accent);
        }

        .btn-primary:hover {
            background: #ff8c42;
        }

        .links-section {
            margin-top: 30px;
        }

        .links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .link-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .link-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px);
        }

        .link-icon {
            font-size: 2rem;
            margin-bottom: 12px;
            color: var(--accent);
        }

        .link-name {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .link-url {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--light);
        }

        .error {
            background: rgba(220, 53, 69, 0.15);
            border-left: 4px solid var(--danger);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .current-location {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .current-location i {
            color: var(--accent);
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-moon"></i>
                <h1>Astro API Dashboard</h1>
            </div>
            <div class="health-status">
                <div class="health-dot"></div>
                <span>API Status: Healthy</span>
            </div>
        </header>

        <div class="controls">
            <div class="input-group">
                <label for="latitude">Latitude</label>
                <input type="number" id="latitude" placeholder="e.g., 40.7128" step="0.0001" value="40.7128">
            </div>
            <div class="input-group">
                <label for="longitude">Longitude</label>
                <input type="number" id="longitude" placeholder="e.g., -74.0060" step="0.0001" value="-74.0060">
            </div>
            <div class="input-group">
                <label for="date">Date (optional)</label>
                <input type="date" id="date">
            </div>
            <button class="btn btn-primary" id="fetch-data">
                <i class="fas fa-sync-alt"></i> Update
            </button>
        </div>

        <div class="current-location">
            <i class="fas fa-map-marker-alt"></i>
            <span>New York City (40.7128° N, 74.0060° W)</span>
        </div>

        <div id="error-container"></div>

        <div class="main-content">
            <div class="card time-card">
                <div class="card-header">
                    <div class="card-title">Current Time</div>
                    <div class="card-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 3.5rem; font-weight: 700; color: var(--primary); line-height: 1.2; margin-bottom: 8px;" id="local-time">--:--:--</div>
                    <div style="font-size: 1.3rem; color: #6c757d; font-weight: 500;" id="date-display">YYYY-MM-DD</div>
                </div>
            </div>

            <div class="card location-card">
                <div class="card-header">
                    <div class="card-title">Location</div>
                    <div class="card-icon">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                </div>
                <div class="card-content">
                    <div class="info-item">
                        <div class="info-label">Latitude</div>
                        <div class="info-value" id="latitude-display">40.7128°</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Longitude</div>
                        <div class="info-value" id="longitude-display">-74.0060°</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Elevation</div>
                        <div class="info-value" id="elevation">0 m</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Timezone</div>
                        <div class="info-value" id="timezone-display">America/New_York</div>
                    </div>
                </div>
            </div>

            <div class="card sun-card">
                <div class="card-header">
                    <div class="card-title">Sun Times</div>
                    <div class="card-icon">
                        <i class="fas fa-sun"></i>
                    </div>
                </div>
                <div class="sun-arc-container">
                    <svg class="sun-arc-svg" id="sun-arc-svg" viewBox="0 0 400 180">
                        <!-- Horizon line -->
                        <line x1="20" y1="150" x2="380" y2="150" class="horizon-line" />

                        <!-- Sun path arc (semicircle) -->
                        <path id="sun-path" class="sun-path" d="M 20 150 Q 200 20, 380 150" />

                        <!-- Sunrise marker -->
                        <g id="sunrise-marker">
                            <line x1="20" y1="150" x2="20" y2="160" class="time-marker-line" />
                            <text x="20" y="172" text-anchor="middle" class="time-marker" id="sunrise-label">Sunrise</text>
                        </g>

                        <!-- Solar noon marker -->
                        <g id="noon-marker">
                            <line x1="200" y1="20" x2="200" y2="10" class="time-marker-line" />
                            <text x="200" y="8" text-anchor="middle" class="time-marker" id="noon-label">Noon</text>
                        </g>

                        <!-- Sunset marker -->
                        <g id="sunset-marker">
                            <line x1="380" y1="150" x2="380" y2="160" class="time-marker-line" />
                            <text x="380" y="172" text-anchor="middle" class="time-marker" id="sunset-label">Sunset</text>
                        </g>

                        <!-- Current sun position -->
                        <g class="sun-position" id="sun-position">
                            <circle cx="200" cy="85" r="12" />
                            <text x="200" y="105" text-anchor="middle" class="time-marker" id="current-time-label">Now</text>
                        </g>
                    </svg>
                    <div class="sun-arc-legend">
                        <div class="legend-item">
                            <i class="fas fa-sunrise" style="color: #ff9e6d;"></i>
                            <span id="arc-sunrise-time">--:--</span>
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-sun" style="color: #ffd700;"></i>
                            <span id="arc-noon-time">--:--</span>
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-sunset" style="color: #ff6b6b;"></i>
                            <span id="arc-sunset-time">--:--</span>
                        </div>
                    </div>
                </div>
                <div class="sun-timeline">
                    <!-- Sunrise Group -->
                    <div class="time-group">
                        <div class="time-group-header">
                            <div class="time-group-icon sunrise-icon">
                                <i class="fas fa-sunrise"></i>
                            </div>
                            <div class="time-group-title">
                                <div class="time-primary">Sunrise <span class="timezone-badge" id="tz-badge-sunrise">UTC</span></div>
                                <div class="time-value" id="sunrise">06:15 AM</div>
                            </div>
                        </div>
                        <div class="time-secondary">
                            <div class="time-detail">
                                <span class="time-detail-label">Civil Dawn</span>
                                <span class="time-detail-value" id="civil-dawn">05:45 AM</span>
                            </div>
                            <div class="time-detail">
                                <span class="time-detail-label">Nautical Dawn</span>
                                <span class="time-detail-value" id="nautical-dawn">05:15 AM</span>
                            </div>
                            <div class="time-detail">
                                <span class="time-detail-label">Astronomical Dawn</span>
                                <span class="time-detail-value" id="astronomical-dawn">04:45 AM</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sunset Group -->
                    <div class="time-group">
                        <div class="time-group-header">
                            <div class="time-group-icon sunset-icon">
                                <i class="fas fa-sunset"></i>
                            </div>
                            <div class="time-group-title">
                                <div class="time-primary">Sunset <span class="timezone-badge" id="tz-badge-sunset">UTC</span></div>
                                <div class="time-value" id="sunset">07:30 PM</div>
                            </div>
                        </div>
                        <div class="time-secondary">
                            <div class="time-detail">
                                <span class="time-detail-label">Civil Dusk</span>
                                <span class="time-detail-value" id="civil-dusk">08:00 PM</span>
                            </div>
                            <div class="time-detail">
                                <span class="time-detail-label">Nautical Dusk</span>
                                <span class="time-detail-value" id="nautical-dusk">08:30 PM</span>
                            </div>
                            <div class="time-detail">
                                <span class="time-detail-label">Astronomical Dusk</span>
                                <span class="time-detail-value" id="astronomical-dusk">09:00 PM</span>
                            </div>
                        </div>
                    </div>

                    <!-- Day Info Group -->
                    <div class="time-group">
                        <div class="time-group-header">
                            <div class="time-group-icon info-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="time-group-title">
                                <div class="time-primary">Day Info</div>
                                <div class="time-value" id="day-length">14h 00m</div>
                            </div>
                        </div>
                        <div class="time-secondary">
                            <div class="time-detail">
                                <span class="time-detail-label">Solar Noon</span>
                                <span class="time-detail-value" id="solar-noon">12:45 PM</span>
                            </div>
                            <div class="time-detail">
                                <span class="time-detail-label">Golden Hour (AM)</span>
                                <span class="time-detail-value" id="golden-morning">6:15-7:00 AM</span>
                            </div>
                            <div class="time-detail">
                                <span class="time-detail-label">Golden Hour (PM)</span>
                                <span class="time-detail-value" id="golden-evening">6:30-7:30 PM</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card moon-card">
                <div class="card-header">
                    <div class="card-title">Moon Information</div>
                    <div class="card-icon">
                        <i class="fas fa-moon"></i>
                    </div>
                </div>
                <div class="moon-phase-visual">
                    <div class="moon-circle" id="moon-visual">
                        <div class="moon-overlay" id="moon-overlay"></div>
                    </div>
                </div>
                <div class="card-content">
                    <div class="info-item">
                        <div class="info-label">Phase</div>
                        <div class="info-value moon-phase" id="moon-phase">Waxing Gibbous</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Phase Day</div>
                        <div class="info-value" id="phase-day">18 of 29</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Illumination</div>
                        <div class="info-value illumination">
                            <span id="illumination-percent">75%</span>
                            <div class="illumination-bar">
                                <div class="illumination-fill" id="illumination-fill" style="width: 75%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="links-section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Service Links</div>
                    <div class="card-icon">
                        <i class="fas fa-link"></i>
                    </div>
                </div>
                <div class="links-grid" id="links-container">
                    <!-- Links will be populated here -->
                </div>
            </div>
        </div>

        <footer>
            <p>Astro API Dashboard • Built with ❤️ for astronomical data visualization</p>
        </footer>
    </div>

    <script>
        const fetchDataBtn = document.getElementById('fetch-data');
        const errorContainer = document.getElementById('error-container');
        const linksContainer = document.getElementById('links-container');
        const currentLocationLabel = document.querySelector('.current-location span');
        const fetchIntervalMs = 30000;

        let refreshTimerId = null;
        let isFetching = false;

        let currentTimezoneOffset = 0;
        let clockInterval = null;

        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();
            startClock();
        });

        async function initDashboard() {
            setDefaultDate();
            attachEventHandlers();

            currentLocationLabel.textContent = 'Detecting current location…';

            await loadServiceLinks();

            const coords = await requestBrowserLocation();
            if (coords) {
                updateLocationInputs(coords.latitude, coords.longitude);
                currentLocationLabel.textContent = 'Using device location';
            } else {
                currentLocationLabel.textContent = formatManualLocationText();
            }

            await fetchAstroData({ suppressError: true });

            startAutoRefresh();
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        function attachEventHandlers() {
            fetchDataBtn.addEventListener('click', () => fetchAstroData());
        }

        async function requestBrowserLocation() {
            if (!('geolocation' in navigator)) {
                return null;
            }

            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve(position.coords),
                    (error) => {
                        console.warn('Geolocation unavailable', error);
                        resolve(null);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            });
        }

        function updateLocationInputs(lat, lon) {
            const latInput = document.getElementById('latitude');
            const lonInput = document.getElementById('longitude');
            latInput.value = Number(lat).toFixed(4);
            lonInput.value = Number(lon).toFixed(4);
        }

        function startAutoRefresh() {
            if (refreshTimerId) {
                clearInterval(refreshTimerId);
            }
            refreshTimerId = setInterval(() => fetchAstroData({ silent: true }), fetchIntervalMs);
        }

        async function fetchAstroData(options = {}) {
            const { silent = false, suppressError = false } = options;
            if (isFetching) {
                return;
            }

            const latValue = parseFloat(document.getElementById('latitude').value);
            const lonValue = parseFloat(document.getElementById('longitude').value);
            const dateInput = document.getElementById('date');
            const dateValue = dateInput.value ? dateInput.value : null;

            if (Number.isNaN(latValue) || Number.isNaN(lonValue)) {
                if (!silent) {
                    showError('Please enter both latitude and longitude');
                }
                return;
            }

            isFetching = true;
            if (!silent) {
                fetchDataBtn.disabled = true;
                fetchDataBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading';
            }
            if (!suppressError) {
                errorContainer.innerHTML = '';
            }

            try {
                const params = new URLSearchParams({
                    lat: latValue.toString(),
                    lon: lonValue.toString(),
                });
                if (dateValue) {
                    params.append('date_str', dateValue);
                }

                const response = await fetch(`/astro?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }

                const data = await response.json();
                updateDashboard(data);
                errorContainer.innerHTML = '';
            } catch (error) {
                console.error('Failed to fetch astro data', error);
                if (!suppressError) {
                    showError(`Error fetching data: ${error.message}`);
                }
            } finally {
                isFetching = false;
                if (!silent) {
                    fetchDataBtn.disabled = false;
                    fetchDataBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Update';
                }
            }
        }

        async function loadServiceLinks() {
            try {
                const response = await fetch('/links');
                if (!response.ok) {
                    throw new Error(`Links request failed with status ${response.status}`);
                }
                const payload = await response.json();
                displayLinks(Array.isArray(payload.links) ? payload.links : []);
            } catch (error) {
                console.warn('Failed to load service links', error);
            }
        }

        function startClock() {
            if (clockInterval) {
                clearInterval(clockInterval);
            }
            clockInterval = setInterval(updateClock, 1000);
            updateClock(); // Initial update
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('local-time').textContent = now.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function updateDashboard(data) {
            const now = new Date(data.now_local);

            // Update date display
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('date-display').textContent = now.toLocaleDateString([], dateOptions);
            document.getElementById('timezone-display').textContent = data.timezone;

            updateLocationInputs(data.query.lat, data.query.lon);
            document.getElementById('latitude-display').textContent = formatCoordinate(data.query.lat, 'lat');
            document.getElementById('longitude-display').textContent = formatCoordinate(data.query.lon, 'lon');
            document.getElementById('elevation').textContent = `${data.query.elevation_m} m`;

            // Update timezone badges
            const tzShort = data.timezone.split('/').pop();
            document.getElementById('tz-badge-sunrise').textContent = tzShort;
            document.getElementById('tz-badge-sunset').textContent = tzShort;

            // Sunrise and dawn times
            document.getElementById('sunrise').textContent = formatTime(data.sun.sunrise);
            document.getElementById('civil-dawn').textContent = formatTime(data.sun.civil_dawn);
            document.getElementById('nautical-dawn').textContent = formatTime(data.sun.nautical_dawn);
            document.getElementById('astronomical-dawn').textContent = formatTime(data.sun.astronomical_dawn);

            // Sunset and dusk times
            document.getElementById('sunset').textContent = formatTime(data.sun.sunset);
            document.getElementById('civil-dusk').textContent = formatTime(data.sun.civil_dusk);
            document.getElementById('nautical-dusk').textContent = formatTime(data.sun.nautical_dusk);
            document.getElementById('astronomical-dusk').textContent = formatTime(data.sun.astronomical_dusk);

            // Day info
            document.getElementById('solar-noon').textContent = formatTime(data.sun.solar_noon);
            document.getElementById('day-length').textContent = formatDayLength(data.sun.day_length_seconds);

            // Golden hours
            if (data.sun.golden_hour_morning) {
                const gmStart = formatTime(data.sun.golden_hour_morning.start);
                const gmEnd = formatTime(data.sun.golden_hour_morning.end);
                document.getElementById('golden-morning').textContent = `${gmStart}-${gmEnd}`;
            } else {
                document.getElementById('golden-morning').textContent = 'N/A';
            }

            if (data.sun.golden_hour_evening) {
                const geStart = formatTime(data.sun.golden_hour_evening.start);
                const geEnd = formatTime(data.sun.golden_hour_evening.end);
                document.getElementById('golden-evening').textContent = `${geStart}-${geEnd}`;
            } else {
                document.getElementById('golden-evening').textContent = 'N/A';
            }

            document.getElementById('moon-phase').textContent = data.moon.phase_name;
            document.getElementById('phase-day').textContent = `${data.moon.phase_day_0_29} of 29`;
            const illuminationPercent = Math.round((data.moon.illumination_fraction_est || 0) * 100);
            document.getElementById('illumination-percent').textContent = `${illuminationPercent}%`;
            document.getElementById('illumination-fill').style.width = `${illuminationPercent}%`;

            // Update moon phase visualization
            updateMoonPhaseVisual(data.moon.phase_day_0_29);

            currentLocationLabel.textContent = `${formatCoordinate(data.query.lat, 'lat')}, ${formatCoordinate(data.query.lon, 'lon')} • ${data.timezone}`;

            // Update sun arc visualization
            updateSunArc(data.sun, data.now_local);
        }

        function updateMoonPhaseVisual(phaseDay) {
            const moonCircle = document.getElementById('moon-visual');
            const moonOverlay = document.getElementById('moon-overlay');

            // Phase day 0 = New Moon, 7 = First Quarter, 14 = Full Moon, 21 = Last Quarter
            // Calculate the illumination angle
            const phase = phaseDay / 29.53; // Normalize to 0-1

            if (phaseDay === 0) {
                // New Moon - all dark
                moonCircle.style.background = '#2c3e50';
                moonOverlay.style.display = 'none';
            } else if (phaseDay === 14 || phaseDay === 15) {
                // Full Moon - all light
                moonCircle.style.background = '#f8f9fa';
                moonOverlay.style.display = 'none';
            } else if (phaseDay < 15) {
                // Waxing (0-15) - light on right side, growing
                moonCircle.style.background = 'linear-gradient(90deg, #2c3e50 50%, #f8f9fa 50%)';
                moonOverlay.className = 'moon-overlay right';
                moonOverlay.style.display = 'block';

                // Calculate the scale for the overlay (creates the curve)
                const scale = Math.abs(Math.cos(phase * Math.PI * 2));
                moonOverlay.style.transform = `scaleX(${scale})`;
                moonOverlay.style.background = phaseDay < 7 ? '#2c3e50' : '#f8f9fa';
            } else {
                // Waning (15-29) - light on left side, shrinking
                moonCircle.style.background = 'linear-gradient(90deg, #f8f9fa 50%, #2c3e50 50%)';
                moonOverlay.className = 'moon-overlay left';
                moonOverlay.style.display = 'block';

                const scale = Math.abs(Math.cos(phase * Math.PI * 2));
                moonOverlay.style.transform = `scaleX(${scale})`;
                moonOverlay.style.background = phaseDay < 22 ? '#f8f9fa' : '#2c3e50';
            }
        }

        function updateSunArc(sunData, nowLocalStr) {
            const sunrise = sunData.sunrise ? new Date(sunData.sunrise) : null;
            const solarNoon = sunData.solar_noon ? new Date(sunData.solar_noon) : null;
            const sunset = sunData.sunset ? new Date(sunData.sunset) : null;
            const now = new Date(nowLocalStr);

            // Update legend times
            document.getElementById('arc-sunrise-time').textContent = formatTime(sunData.sunrise);
            document.getElementById('arc-noon-time').textContent = formatTime(sunData.solar_noon);
            document.getElementById('arc-sunset-time').textContent = formatTime(sunData.sunset);

            if (!sunrise || !sunset || !solarNoon) {
                // Polar day/night - hide sun position or show edge case
                const sunPosition = document.getElementById('sun-position');
                sunPosition.style.opacity = '0.3';
                return;
            }

            const sunPosition = document.getElementById('sun-position');
            sunPosition.style.opacity = '1';

            const nowTime = now.getTime();
            const sunriseTime = sunrise.getTime();
            const sunsetTime = sunset.getTime();

            // Calculate position along the arc (0 = sunrise, 0.5 = noon, 1 = sunset)
            let progress;
            if (nowTime < sunriseTime) {
                // Before sunrise - sun below horizon on left
                progress = -0.1;
            } else if (nowTime > sunsetTime) {
                // After sunset - sun below horizon on right
                progress = 1.1;
            } else {
                // During daylight - calculate position along arc
                progress = (nowTime - sunriseTime) / (sunsetTime - sunriseTime);
            }

            // Convert progress to position on the semicircle arc
            // Arc goes from (20, 150) through (200, 20) to (380, 150)
            // Using quadratic Bezier curve: P(t) = (1-t)²P₀ + 2(1-t)tP₁ + t²P₂
            const t = progress;
            const x = Math.pow(1 - t, 2) * 20 + 2 * (1 - t) * t * 200 + Math.pow(t, 2) * 380;
            const y = Math.pow(1 - t, 2) * 150 + 2 * (1 - t) * t * 20 + Math.pow(t, 2) * 150;

            // Update sun position
            const circle = sunPosition.querySelector('circle');
            const label = sunPosition.querySelector('text');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            label.setAttribute('x', x);
            label.setAttribute('y', y + 20);

            // Update label to show if sun is below horizon
            if (progress < 0 || progress > 1) {
                label.textContent = 'Below Horizon';
                circle.style.opacity = '0.4';
            } else {
                label.textContent = 'Now';
                circle.style.opacity = '1';
            }
        }

        function displayLinks(links) {
            if (!links.length) {
                linksContainer.innerHTML = `
                    <div class="link-card">
                        <div class="link-name">No links available</div>
                    </div>
                `;
                return;
            }

            linksContainer.innerHTML = '';
            links.forEach((link) => {
                const linkCard = document.createElement('div');
                linkCard.className = 'link-card';
                linkCard.innerHTML = `
                    <div class="link-icon">
                        <i class="${link.icon || 'fas fa-link'}"></i>
                    </div>
                    <div class="link-name">${link.name}</div>
                    <a href="${link.url}" class="link-url" target="_blank" rel="noopener">${link.url}</a>
                `;
                linksContainer.appendChild(linkCard);
            });
        }

        function formatTime(dateTimeStr) {
            if (!dateTimeStr) {
                return 'N/A';
            }
            const parsed = new Date(dateTimeStr);
            if (Number.isNaN(parsed.getTime())) {
                return 'N/A';
            }
            return parsed.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatDayLength(seconds) {
            if (seconds === null || seconds === undefined) {
                return 'N/A';
            }
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes.toString().padStart(2, '0')}m`;
        }

        function showError(message) {
            errorContainer.innerHTML = `
                <div class="error">
                    <i class="fas fa-exclamation-circle"></i> ${message}
                </div>
            `;
        }

        function formatCoordinate(value, type) {
            if (typeof value !== 'number' || Number.isNaN(value)) {
                return 'N/A';
            }
            const abs = Math.abs(value).toFixed(4);
            const direction = type === 'lat'
                ? value >= 0 ? 'N' : 'S'
                : value >= 0 ? 'E' : 'W';
            return `${abs}° ${direction}`;
        }

        function formatManualLocationText() {
            const latValue = parseFloat(document.getElementById('latitude').value);
            const lonValue = parseFloat(document.getElementById('longitude').value);
            if (Number.isNaN(latValue) || Number.isNaN(lonValue)) {
                return 'Manual coordinates not set';
            }
            return `Manual coordinates (${formatCoordinate(latValue, 'lat')}, ${formatCoordinate(lonValue, 'lon')})`;
        }
    </script>
</body>
</html>
