<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astro API Dashboard</title>

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicons/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    <link rel="manifest" href="/favicons/site.webmanifest">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #6b8cbc;
            --accent: #ff9e6d;
            --dark: #2c3e50;
            --light: #f8f9fa;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 2.2rem;
            color: var(--accent);
        }

        .logo h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(to right, #ff9e6d, #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .health-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            font-weight: 600;
        }

        .health-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 25px;
            color: var(--dark);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .sun-card .card-icon {
            background: linear-gradient(135deg, #ffd700, #ff9e6d);
            color: white;
        }

        .moon-card .card-icon {
            background: linear-gradient(135deg, #4a6fa5, #2c3e50);
            color: white;
        }

        .time-card .card-icon {
            background: linear-gradient(135deg, #6b8cbc, #4a6fa5);
            color: white;
        }

        .location-card .card-icon {
            background: linear-gradient(135deg, #ff9e6d, #ffd700);
            color: white;
        }

        .card-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 600px) {
            .card-content {
                grid-template-columns: 1fr;
            }
        }

        .info-item {
            margin-bottom: 15px;
        }

        .info-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }

        .info-value.large {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .info-value.moon-phase {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .info-value.illumination {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .illumination-bar {
            height: 8px;
            width: 100px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .illumination-fill {
            height: 100%;
            background: linear-gradient(to right, #4a6fa5, #ff9e6d);
            border-radius: 4px;
        }

        .sun-timeline {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 15px;
        }

        @media (max-width: 700px) {
            .sun-timeline {
                grid-template-columns: 1fr;
            }
        }

        .time-group {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .time-group:hover {
            background: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .time-group-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .time-group-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .time-group-icon.sunrise-icon {
            background: linear-gradient(135deg, #ff9e6d 0%, #ffd700 100%);
            color: white;
        }

        .time-group-icon.sunset-icon {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff9e6d 100%);
            color: white;
        }

        .time-group-icon.info-icon {
            background: linear-gradient(135deg, #4a6fa5 0%, #6b8cbc 100%);
            color: white;
        }

        .time-group-title {
            flex: 1;
        }

        .time-primary {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 2px;
        }

        .time-value {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--primary);
        }

        .time-secondary {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
        }

        .time-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .time-detail:last-child {
            margin-bottom: 0;
        }

        .time-detail-label {
            color: #6c757d;
            font-weight: 500;
        }

        .time-detail-value {
            color: var(--dark);
            font-weight: 600;
        }

        .timezone-badge {
            display: inline-block;
            background: rgba(74, 111, 165, 0.1);
            color: var(--primary);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 6px;
        }

        .sun-arc-container {
            margin: 20px 0 25px 0;
            padding: 20px;
            background: linear-gradient(180deg, #e3f2fd 0%, #f5f5f5 50%, #f0ead6 100%);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .sun-arc-container::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(240, 234, 214, 0) 0%, rgba(205, 186, 150, 0.15) 100%);
            border-radius: 0 0 12px 12px;
        }

        .sun-arc-svg {
            width: 100%;
            height: 180px;
            display: block;
        }

        .horizon-line {
            stroke: #8b4513;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
            opacity: 0.6;
        }

        .sun-path {
            fill: none;
            stroke: #ff9e6d;
            stroke-width: 3;
            stroke-dasharray: 8, 4;
            opacity: 0.8;
        }

        .sun-position {
            filter: drop-shadow(0 0 8px rgba(255, 193, 7, 0.8));
            transition: all 0.5s ease;
        }

        .sun-position circle {
            fill: #ffd700;
            stroke: #ff9e6d;
            stroke-width: 3;
        }

        .time-marker {
            font-size: 11px;
            fill: #495057;
            font-weight: 600;
        }

        .time-marker-line {
            stroke: #495057;
            stroke-width: 1;
            opacity: 0.4;
        }

        .sun-arc-legend {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #495057;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-item i {
            font-size: 1rem;
        }

        .moon-phase-visual {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .moon-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(90deg, #2c3e50 50%, #f8f9fa 50%);
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .moon-overlay {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            background: #f8f9fa;
            border-radius: 50%;
        }

        .moon-overlay.left {
            left: 0;
        }

        .moon-overlay.right {
            right: 0;
        }

        .day-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 5px;
        }

        .day-indicator.day {
            background: rgba(40, 167, 69, 0.15);
            color: var(--success);
        }

        .day-indicator.night {
            background: rgba(44, 62, 80, 0.15);
            color: var(--dark);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--light);
        }

        .input-group input, .input-group select {
            padding: 12px 15px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--accent);
        }

        .btn-primary:hover {
            background: #ff8c42;
        }

        .links-section {
            margin-top: 30px;
        }

        .links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .link-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .link-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px);
        }

        .link-icon {
            font-size: 2rem;
            margin-bottom: 12px;
            color: var(--accent);
        }

        .link-name {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .link-url {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--light);
        }

        .error {
            background: rgba(220, 53, 69, 0.15);
            border-left: 4px solid var(--danger);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .current-location {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .current-location i {
            color: var(--accent);
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .collapsible-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            overflow: hidden;
            transition: var(--transition);
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
        }

        .collapsible-header:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .collapsible-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--light);
        }

        .collapsible-icon {
            transition: transform 0.3s ease;
            color: var(--accent);
        }

        .collapsible-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 20px 20px 20px;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            padding: 0 20px;
        }

        .weather-card .card-icon {
            background: linear-gradient(135deg, #87ceeb, #4a90e2);
            color: white;
        }

        .weather-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .weather-temp {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .weather-icon img {
            width: 64px;
            height: 64px;
        }

        .temp-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .weather-condition {
            font-size: 1.1rem;
            color: #6c757d;
            margin-top: 5px;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .weather-detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .weather-detail-item i {
            color: var(--primary);
            width: 20px;
        }

        .weather-detail-label {
            color: #6c757d;
            margin-right: 5px;
        }

        .weather-detail-value {
            font-weight: 600;
            color: var(--dark);
        }

        .weather-forecast {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .forecast-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .forecast-days {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        @media (max-width: 600px) {
            .forecast-days {
                grid-template-columns: 1fr;
            }
        }

        .forecast-day {
            background: rgba(74, 111, 165, 0.05);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: var(--transition);
        }

        .forecast-day:hover {
            background: rgba(74, 111, 165, 0.1);
            transform: translateY(-2px);
        }

        .forecast-date {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .forecast-icon img {
            width: 48px;
            height: 48px;
        }

        .forecast-temp {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark);
            margin: 8px 0;
        }

        .forecast-temp-range {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 6px;
        }

        .forecast-condition {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 6px;
        }

        .forecast-detail {
            display: flex;
            justify-content: space-around;
            font-size: 0.7rem;
            color: #6c757d;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
        }

        .forecast-detail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .forecast-detail-item i {
            color: var(--primary);
            font-size: 0.85rem;
        }

        .last-updated {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 15px;
            text-align: right;
            font-style: italic;
        }

        .last-updated i {
            margin-right: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-moon"></i>
                <h1>Astro API Dashboard</h1>
            </div>
            <div class="health-status">
                <div class="health-dot"></div>
                <span>API Status: Healthy</span>
            </div>
        </header>

        <div class="collapsible-section">
            <div class="collapsible-header" id="location-toggle">
                <div class="collapsible-title">
                    <i class="fas fa-map-marker-alt"></i> Custom Location
                </div>
                <i class="fas fa-chevron-down collapsible-icon collapsed" id="location-icon"></i>
            </div>
            <div class="collapsible-content collapsed" id="location-form">
                <div class="controls">
                    <div class="input-group">
                        <label for="latitude">Latitude</label>
                        <input type="number" id="latitude" placeholder="e.g., 40.7128" step="0.0001" value="40.7128">
                    </div>
                    <div class="input-group">
                        <label for="longitude">Longitude</label>
                        <input type="number" id="longitude" placeholder="e.g., -74.0060" step="0.0001" value="-74.0060">
                    </div>
                    <div class="input-group">
                        <label for="date">Date (optional)</label>
                        <input type="date" id="date">
                    </div>
                    <button class="btn btn-primary" id="fetch-data">
                        <i class="fas fa-sync-alt"></i> Update
                    </button>
                </div>
            </div>
        </div>

        <div class="current-location">
            <i class="fas fa-map-marker-alt"></i>
            <span>New York City (40.7128° N, 74.0060° W)</span>
        </div>

        <div id="error-container"></div>

        <div class="main-content">
            <div class="card time-card">
                <div class="card-header">
                    <div class="card-title">Current Time</div>
                    <div class="card-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 3.5rem; font-weight: 700; color: var(--primary); line-height: 1.2; margin-bottom: 8px;" id="local-time">--:--:--</div>
                    <div style="font-size: 1.3rem; color: #6c757d; font-weight: 500;" id="date-display">YYYY-MM-DD</div>
                </div>
            </div>

            <div class="card location-card">
                <div class="card-header">
                    <div class="card-title">Location</div>
                    <div class="card-icon">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                </div>
                <div class="card-content">
                    <div class="info-item">
                        <div class="info-label">Latitude</div>
                        <div class="info-value" id="latitude-display">40.7128°</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Longitude</div>
                        <div class="info-value" id="longitude-display">-74.0060°</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Elevation</div>
                        <div class="info-value" id="elevation">0 m</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Timezone</div>
                        <div class="info-value" id="timezone-display">America/New_York</div>
                    </div>
                </div>
            </div>

            <div class="card weather-card">
                <div class="card-header">
                    <div class="card-title">Weather</div>
                    <div class="card-icon">
                        <i class="fas fa-cloud-sun"></i>
                    </div>
                </div>
                <div class="weather-main">
                    <div class="weather-temp">
                        <div class="weather-icon">
                            <img id="weather-icon" src="" alt="Weather">
                        </div>
                        <div>
                            <div class="temp-display" id="temperature">--°</div>
                            <div class="weather-condition" id="weather-condition">Loading...</div>
                        </div>
                    </div>
                </div>
                <div class="weather-details">
                    <div class="weather-detail-item">
                        <i class="fas fa-temperature-high"></i>
                        <span class="weather-detail-label">Feels like:</span>
                        <span class="weather-detail-value" id="feels-like">--°</span>
                    </div>
                    <div class="weather-detail-item">
                        <i class="fas fa-tint"></i>
                        <span class="weather-detail-label">Humidity:</span>
                        <span class="weather-detail-value" id="humidity">--%</span>
                    </div>
                    <div class="weather-detail-item">
                        <i class="fas fa-wind"></i>
                        <span class="weather-detail-label">Wind:</span>
                        <span class="weather-detail-value" id="wind">-- km/h</span>
                    </div>
                    <div class="weather-detail-item">
                        <i class="fas fa-compress-arrows-alt"></i>
                        <span class="weather-detail-label">Pressure:</span>
                        <span class="weather-detail-value" id="pressure">-- mb</span>
                    </div>
                    <div class="weather-detail-item">
                        <i class="fas fa-cloud-rain"></i>
                        <span class="weather-detail-label">Precip:</span>
                        <span class="weather-detail-value" id="precipitation">-- mm</span>
                    </div>
                    <div class="weather-detail-item">
                        <i class="fas fa-sun"></i>
                        <span class="weather-detail-label">UV Index:</span>
                        <span class="weather-detail-value" id="uv-index">--</span>
                    </div>
                </div>
                <div class="weather-forecast" id="weather-forecast" style="display: none;">
                    <div class="forecast-title">3-Day Forecast</div>
                    <div class="forecast-days" id="forecast-days">
                        <!-- Forecast days will be populated here -->
                    </div>
                </div>
                <div class="last-updated">
                    <i class="fas fa-clock"></i>
                    <span id="weather-last-updated">--</span>
                </div>
            </div>

            <div class="card sun-card">
                <div class="card-header">
                    <div class="card-title">Sun Times</div>
                    <div class="card-icon">
                        <i class="fas fa-sun"></i>
                    </div>
                </div>
                <div class="sun-arc-container">
                    <svg class="sun-arc-svg" id="sun-arc-svg" viewBox="0 0 400 180">
                        <!-- Horizon line -->
                        <line x1="20" y1="150" x2="380" y2="150" class="horizon-line" />

                        <!-- Sun path arc (semicircle) -->
                        <path id="sun-path" class="sun-path" d="M 20 150 Q 200 20, 380 150" />

                        <!-- Sunrise marker -->
                        <g id="sunrise-marker">
                            <line x1="20" y1="150" x2="20" y2="160" class="time-marker-line" />
                            <text x="20" y="172" text-anchor="middle" class="time-marker" id="sunrise-label">Sunrise</text>
                        </g>

                        <!-- Solar noon marker -->
                        <g id="noon-marker">
                            <line x1="200" y1="20" x2="200" y2="10" class="time-marker-line" />
                            <text x="200" y="8" text-anchor="middle" class="time-marker" id="noon-label">Noon</text>
                        </g>

                        <!-- Sunset marker -->
                        <g id="sunset-marker">
                            <line x1="380" y1="150" x2="380" y2="160" class="time-marker-line" />
                            <text x="380" y="172" text-anchor="middle" class="time-marker" id="sunset-label">Sunset</text>
                        </g>

                        <!-- Current sun position -->
                        <g class="sun-position" id="sun-position">
                            <circle cx="200" cy="85" r="12" />
                            <text x="200" y="105" text-anchor="middle" class="time-marker" id="current-time-label">Now</text>
                        </g>
                    </svg>
                    <div class="sun-arc-legend">
                        <div class="legend-item">
                            <i class="fas fa-sunrise" style="color: #ff9e6d;"></i>
                            <span id="arc-sunrise-time">--:--</span>
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-sun" style="color: #ffd700;"></i>
                            <span id="arc-noon-time">--:--</span>
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-sunset" style="color: #ff6b6b;"></i>
                            <span id="arc-sunset-time">--:--</span>
                        </div>
                    </div>
                </div>
                <div class="sun-timeline">
                    <!-- Sunrise Group -->
                    <div class="time-group">
                        <div class="time-group-header">
                            <div class="time-group-icon sunrise-icon">
                                <i class="fas fa-sunrise"></i>
                            </div>
                            <div class="time-group-title">
                                <div class="time-primary">Sunrise <span class="timezone-badge" id="tz-badge-sunrise">UTC</span></div>
                                <div class="time-value" id="sunrise">06:15 AM</div>
                            </div>
                        </div>
                        <div class="time-secondary">
                            <div class="time-detail">
                                <span class="time-detail-label">Civil Dawn</span>
                                <span class="time-detail-value" id="civil-dawn">05:45 AM</span>
                            </div>
                            <div class="time-detail">
                                <span class="time-detail-label">Nautical Dawn</span>
                                <span class="time-detail-value" id="nautical-dawn">05:15 AM</span>
                            </div>
                            <div class="time-detail">
                                <span class="time-detail-label">Astronomical Dawn</span>
                                <span class="time-detail-value" id="astronomical-dawn">04:45 AM</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sunset Group -->
                    <div class="time-group">
                        <div class="time-group-header">
                            <div class="time-group-icon sunset-icon">
                                <i class="fas fa-sunset"></i>
                            </div>
                            <div class="time-group-title">
                                <div class="time-primary">Sunset <span class="timezone-badge" id="tz-badge-sunset">UTC</span></div>
                                <div class="time-value" id="sunset">07:30 PM</div>
                            </div>
                        </div>
                        <div class="time-secondary">
                            <div class="time-detail">
                                <span class="time-detail-label">Civil Dusk</span>
                                <span class="time-detail-value" id="civil-dusk">08:00 PM</span>
                            </div>
                            <div class="time-detail">
                                <span class="time-detail-label">Nautical Dusk</span>
                                <span class="time-detail-value" id="nautical-dusk">08:30 PM</span>
                            </div>
                            <div class="time-detail">
                                <span class="time-detail-label">Astronomical Dusk</span>
                                <span class="time-detail-value" id="astronomical-dusk">09:00 PM</span>
                            </div>
                        </div>
                    </div>

                    <!-- Day Info Group -->
                    <div class="time-group">
                        <div class="time-group-header">
                            <div class="time-group-icon info-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="time-group-title">
                                <div class="time-primary">Day Info</div>
                                <div class="time-value" id="day-length">14h 00m</div>
                            </div>
                        </div>
                        <div class="time-secondary">
                            <div class="time-detail">
                                <span class="time-detail-label">Solar Noon</span>
                                <span class="time-detail-value" id="solar-noon">12:45 PM</span>
                            </div>
                            <div class="time-detail">
                                <span class="time-detail-label">Golden Hour (AM)</span>
                                <span class="time-detail-value" id="golden-morning">6:15-7:00 AM</span>
                            </div>
                            <div class="time-detail">
                                <span class="time-detail-label">Golden Hour (PM)</span>
                                <span class="time-detail-value" id="golden-evening">6:30-7:30 PM</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="last-updated">
                    <i class="fas fa-clock"></i>
                    <span id="sun-last-updated">--</span>
                </div>
            </div>

            <div class="card moon-card">
                <div class="card-header">
                    <div class="card-title">Moon Information</div>
                    <div class="card-icon">
                        <i class="fas fa-moon"></i>
                    </div>
                </div>
                <div class="moon-phase-visual">
                    <div class="moon-circle" id="moon-visual">
                        <div class="moon-overlay" id="moon-overlay"></div>
                    </div>
                </div>
                <div class="card-content">
                    <div class="info-item">
                        <div class="info-label">Phase</div>
                        <div class="info-value moon-phase" id="moon-phase">Waxing Gibbous</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Phase Day</div>
                        <div class="info-value" id="phase-day">18 of 29</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Illumination</div>
                        <div class="info-value illumination">
                            <span id="illumination-percent">75%</span>
                            <div class="illumination-bar">
                                <div class="illumination-fill" id="illumination-fill" style="width: 75%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Next New Moon</div>
                        <div class="info-value" id="next-new-moon">2024-10-15</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Next Full Moon</div>
                        <div class="info-value" id="next-full-moon">2024-10-30</div>
                    </div>
                </div>
                <div class="last-updated">
                    <i class="fas fa-clock"></i>
                    <span id="moon-last-updated">--</span>
                </div>
            </div>
        </div>

        <div class="links-section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Service Links</div>
                    <div class="card-icon">
                        <i class="fas fa-link"></i>
                    </div>
                </div>
                <div class="links-grid" id="links-container">
                    <!-- Links will be populated here -->
                </div>
            </div>
        </div>

        <footer>
            <p>Astro API Dashboard • Built with ❤️ for astronomical data visualization</p>
        </footer>
    </div>

    <script>
        const fetchDataBtn = document.getElementById('fetch-data');
        const errorContainer = document.getElementById('error-container');
        const linksContainer = document.getElementById('links-container');
        const currentLocationLabel = document.querySelector('.current-location span');

        let refreshTimerId = null;
        let isFetching = false;

        let currentTimezone = null;
        let clockInterval = null;
        let weatherRefreshTimer = null;
        let lastWeatherUpdate = null;
        let lastAstroUpdate = null;
        let currentSunData = null; // Store sun data for real-time position updates
        const CACHE_KEY = 'astro_dashboard_cache';
        const CACHE_DURATION_MS = 24 * 60 * 60 * 1000; // 24 hours for sun/moon data
        const WEATHER_REFRESH_MS = 15 * 60 * 1000; // 15 minutes for weather data

        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();
            startClock();
        });

        function saveToCache(data) {
            try {
                const cacheEntry = {
                    data: data,
                    timestamp: Date.now(),
                    lat: data.query.lat,
                    lon: data.query.lon,
                    date: data.sun.date
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheEntry));
            } catch (e) {
                console.warn('Failed to save to localStorage:', e);
            }
        }

        function loadFromCache() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (!cached) {
                    return null;
                }
                const cacheEntry = JSON.parse(cached);
                const age = Date.now() - cacheEntry.timestamp;

                // Return cached data even if stale - we'll update it in the background
                // But mark it as stale if older than cache duration
                if (age < CACHE_DURATION_MS) {
                    return { data: cacheEntry.data, fresh: true };
                } else {
                    return { data: cacheEntry.data, fresh: false };
                }
            } catch (e) {
                console.warn('Failed to load from localStorage:', e);
                return null;
            }
        }

        function shouldRefetchAstroData() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (!cached) {
                    return true; // No cache, need to fetch
                }

                const cacheEntry = JSON.parse(cached);
                const currentLat = parseFloat(document.getElementById('latitude').value);
                const currentLon = parseFloat(document.getElementById('longitude').value);
                const currentDate = document.getElementById('date').value;
                const todayDate = new Date().toISOString().split('T')[0];

                // Check if location changed significantly (more than 0.01 degrees ~ 1km)
                const latDiff = Math.abs(cacheEntry.lat - currentLat);
                const lonDiff = Math.abs(cacheEntry.lon - currentLon);
                if (latDiff > 0.01 || lonDiff > 0.01) {
                    return true;
                }

                // Check if date changed (user selected different date)
                const targetDate = currentDate || todayDate;
                if (cacheEntry.date !== targetDate) {
                    return true;
                }

                // Check if cache is older than 24 hours
                const age = Date.now() - cacheEntry.timestamp;
                if (age > CACHE_DURATION_MS) {
                    return true;
                }

                // Check if we've crossed midnight (need new sun/moon data for today)
                const cachedDate = new Date(cacheEntry.timestamp).toISOString().split('T')[0];
                if (cachedDate !== todayDate && !currentDate) {
                    return true;
                }

                return false; // Cache is valid
            } catch (e) {
                console.warn('Error checking cache validity:', e);
                return true; // On error, fetch new data
            }
        }

        async function initDashboard() {
            setDefaultDate();
            attachEventHandlers();

            currentLocationLabel.textContent = 'Detecting current location…';

            // Load cached data immediately if available
            const cached = loadFromCache();
            if (cached) {
                console.log('Loading from cache', cached.fresh ? '(fresh)' : '(stale)');
                updateDashboard(cached.data);
                // Set lastAstroUpdate to cache timestamp for accurate "last updated" display
                try {
                    const cacheEntry = JSON.parse(localStorage.getItem(CACHE_KEY));
                    if (cacheEntry && cacheEntry.timestamp) {
                        lastAstroUpdate = cacheEntry.timestamp;
                    }
                } catch (e) {
                    // Ignore errors
                }
                // Update location inputs from cached data
                if (cached.data.query) {
                    updateLocationInputs(cached.data.query.lat, cached.data.query.lon);
                }
            }

            await loadServiceLinks();

            const coords = await requestBrowserLocation();
            if (coords) {
                updateLocationInputs(coords.latitude, coords.longitude);
                currentLocationLabel.textContent = 'Using device location';
            } else {
                currentLocationLabel.textContent = formatManualLocationText();
            }

            // Fetch fresh data only if cache is invalid
            if (shouldRefetchAstroData()) {
                console.log('Cache invalid or stale, fetching fresh data');
                await fetchAstroData({ suppressError: true });
            } else {
                console.log('Using cached data, no fetch needed');
            }

            // Fetch weather data and start auto-refresh
            await fetchWeatherData();
            startWeatherRefresh();

            // Don't auto-refresh astro data - we have 24h cache and manual update button
            // startAutoRefresh();
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        function attachEventHandlers() {
            fetchDataBtn.addEventListener('click', () => {
                fetchAstroData();
                fetchWeatherData(); // Also update weather when user clicks Update
            });

            // Collapsible location form
            const locationToggle = document.getElementById('location-toggle');
            const locationForm = document.getElementById('location-form');
            const locationIcon = document.getElementById('location-icon');

            locationToggle.addEventListener('click', () => {
                locationForm.classList.toggle('collapsed');
                locationIcon.classList.toggle('collapsed');
            });
        }

        async function requestBrowserLocation() {
            if (!('geolocation' in navigator)) {
                return null;
            }

            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve(position.coords),
                    (error) => {
                        console.warn('Geolocation unavailable', error);
                        resolve(null);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            });
        }

        function updateLocationInputs(lat, lon) {
            const latInput = document.getElementById('latitude');
            const lonInput = document.getElementById('longitude');
            latInput.value = Number(lat).toFixed(4);
            lonInput.value = Number(lon).toFixed(4);
        }

        function startAutoRefresh() {
            if (refreshTimerId) {
                clearInterval(refreshTimerId);
            }
            refreshTimerId = setInterval(() => fetchAstroData({ silent: true }), fetchIntervalMs);
        }

        async function fetchAstroData(options = {}) {
            const { silent = false, suppressError = false } = options;
            if (isFetching) {
                return;
            }

            const latValue = parseFloat(document.getElementById('latitude').value);
            const lonValue = parseFloat(document.getElementById('longitude').value);
            const dateInput = document.getElementById('date');
            const dateValue = dateInput.value ? dateInput.value : null;

            if (Number.isNaN(latValue) || Number.isNaN(lonValue)) {
                if (!silent) {
                    showError('Please enter both latitude and longitude');
                }
                return;
            }

            isFetching = true;
            if (!silent) {
                fetchDataBtn.disabled = true;
                fetchDataBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading';
            }
            if (!suppressError) {
                errorContainer.innerHTML = '';
            }

            try {
                const params = new URLSearchParams({
                    lat: latValue.toString(),
                    lon: lonValue.toString(),
                });
                if (dateValue) {
                    params.append('date_str', dateValue);
                }

                const response = await fetch(`/astro?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }

                const data = await response.json();
                updateDashboard(data);
                saveToCache(data); // Save to cache for next load
                lastAstroUpdate = Date.now(); // Track when astro data was updated
                errorContainer.innerHTML = '';
            } catch (error) {
                console.error('Failed to fetch astro data', error);
                if (!suppressError) {
                    showError(`Error fetching data: ${error.message}`);
                }
            } finally {
                isFetching = false;
                if (!silent) {
                    fetchDataBtn.disabled = false;
                    fetchDataBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Update';
                }
            }
        }

        async function loadServiceLinks() {
            try {
                const response = await fetch('/links');
                if (!response.ok) {
                    throw new Error(`Links request failed with status ${response.status}`);
                }
                const payload = await response.json();
                displayLinks(Array.isArray(payload.links) ? payload.links : []);
            } catch (error) {
                console.warn('Failed to load service links', error);
            }
        }

        function startClock() {
            if (clockInterval) {
                clearInterval(clockInterval);
            }
            clockInterval = setInterval(updateClock, 1000);
            updateClock(); // Initial update
        }

        function updateClock() {
            // If we have a timezone from the API, use it for display
            // Otherwise fall back to local time
            if (currentTimezone) {
                try {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        timeZone: currentTimezone,
                        hour12: false
                    });
                    document.getElementById('local-time').textContent = timeStr;
                } catch (e) {
                    // Fallback to local time if timezone is invalid
                    const now = new Date();
                    document.getElementById('local-time').textContent = now.toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                }
            } else {
                const now = new Date();
                document.getElementById('local-time').textContent = now.toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }

            // Update "last updated" timestamps
            updateLastUpdatedDisplays();

            // Update sun position in real-time
            if (currentSunData) {
                updateSunArc(currentSunData);
            }
        }

        function updateLastUpdatedDisplays() {
            const now = Date.now();

            if (lastWeatherUpdate) {
                document.getElementById('weather-last-updated').textContent = formatTimeAgo(now - lastWeatherUpdate);
            }

            if (lastAstroUpdate) {
                const astroText = formatTimeAgo(now - lastAstroUpdate);
                document.getElementById('sun-last-updated').textContent = astroText;
                document.getElementById('moon-last-updated').textContent = astroText;
            }
        }

        function formatTimeAgo(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (seconds < 60) {
                return 'Updated just now';
            } else if (minutes < 60) {
                return `Updated ${minutes} min${minutes !== 1 ? 's' : ''} ago`;
            } else if (hours < 24) {
                return `Updated ${hours} hour${hours !== 1 ? 's' : ''} ago`;
            } else {
                return `Updated ${days} day${days !== 1 ? 's' : ''} ago`;
            }
        }

        function updateDashboard(data) {
            const now = new Date(data.now_local);

            // Store timezone for clock updates
            currentTimezone = data.timezone;

            // Update date display
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('date-display').textContent = now.toLocaleDateString([], dateOptions);
            document.getElementById('timezone-display').textContent = data.timezone;

            updateLocationInputs(data.query.lat, data.query.lon);
            document.getElementById('latitude-display').textContent = formatCoordinate(data.query.lat, 'lat');
            document.getElementById('longitude-display').textContent = formatCoordinate(data.query.lon, 'lon');
            document.getElementById('elevation').textContent = `${data.query.elevation_m} m`;

            // Update timezone badges
            const tzShort = data.timezone.split('/').pop();
            document.getElementById('tz-badge-sunrise').textContent = tzShort;
            document.getElementById('tz-badge-sunset').textContent = tzShort;

            // Sunrise and dawn times
            document.getElementById('sunrise').textContent = formatTime(data.sun.sunrise);
            document.getElementById('civil-dawn').textContent = formatTime(data.sun.civil_dawn);
            document.getElementById('nautical-dawn').textContent = formatTime(data.sun.nautical_dawn);
            document.getElementById('astronomical-dawn').textContent = formatTime(data.sun.astronomical_dawn);

            // Sunset and dusk times
            document.getElementById('sunset').textContent = formatTime(data.sun.sunset);
            document.getElementById('civil-dusk').textContent = formatTime(data.sun.civil_dusk);
            document.getElementById('nautical-dusk').textContent = formatTime(data.sun.nautical_dusk);
            document.getElementById('astronomical-dusk').textContent = formatTime(data.sun.astronomical_dusk);

            // Day info
            document.getElementById('solar-noon').textContent = formatTime(data.sun.solar_noon);
            document.getElementById('day-length').textContent = formatDayLength(data.sun.day_length_seconds);

            // Golden hours
            if (data.sun.golden_hour_morning) {
                const gmStart = formatTime(data.sun.golden_hour_morning.start);
                const gmEnd = formatTime(data.sun.golden_hour_morning.end);
                document.getElementById('golden-morning').textContent = `${gmStart}-${gmEnd}`;
            } else {
                document.getElementById('golden-morning').textContent = 'N/A';
            }

            if (data.sun.golden_hour_evening) {
                const geStart = formatTime(data.sun.golden_hour_evening.start);
                const geEnd = formatTime(data.sun.golden_hour_evening.end);
                document.getElementById('golden-evening').textContent = `${geStart}-${geEnd}`;
            } else {
                document.getElementById('golden-evening').textContent = 'N/A';
            }

            document.getElementById('moon-phase').textContent = data.moon.phase_name;
            document.getElementById('phase-day').textContent = `${data.moon.phase_day_0_29} of 29`;
            const illuminationPercent = Math.round((data.moon.illumination_fraction_est || 0) * 100);
            document.getElementById('illumination-percent').textContent = `${illuminationPercent}%`;
            document.getElementById('illumination-fill').style.width = `${illuminationPercent}%`;

            // Update next moon phases
            document.getElementById('next-new-moon').textContent = formatDate(data.moon.next_new_moon);
            document.getElementById('next-full-moon').textContent = formatDate(data.moon.next_full_moon);

            // Update moon phase visualization
            updateMoonPhaseVisual(data.moon.phase_day_0_29);

            currentLocationLabel.textContent = `${formatCoordinate(data.query.lat, 'lat')}, ${formatCoordinate(data.query.lon, 'lon')} • ${data.timezone}`;

            // Store sun data for real-time updates
            currentSunData = data.sun;

            // Update sun arc visualization with current time
            updateSunArc(data.sun);
        }

        function updateMoonPhaseVisual(phaseDay) {
            const moonCircle = document.getElementById('moon-visual');
            const moonOverlay = document.getElementById('moon-overlay');

            // Phase day 0 = New Moon, 7 = First Quarter, 14 = Full Moon, 21 = Last Quarter
            // Calculate the illumination angle
            const phase = phaseDay / 29.53; // Normalize to 0-1

            if (phaseDay === 0) {
                // New Moon - all dark
                moonCircle.style.background = '#2c3e50';
                moonOverlay.style.display = 'none';
            } else if (phaseDay === 14 || phaseDay === 15) {
                // Full Moon - all light
                moonCircle.style.background = '#f8f9fa';
                moonOverlay.style.display = 'none';
            } else if (phaseDay < 15) {
                // Waxing (0-15) - light on right side, growing
                moonCircle.style.background = 'linear-gradient(90deg, #2c3e50 50%, #f8f9fa 50%)';
                moonOverlay.className = 'moon-overlay right';
                moonOverlay.style.display = 'block';

                // Calculate the scale for the overlay (creates the curve)
                const scale = Math.abs(Math.cos(phase * Math.PI * 2));
                moonOverlay.style.transform = `scaleX(${scale})`;
                moonOverlay.style.background = phaseDay < 7 ? '#2c3e50' : '#f8f9fa';
            } else {
                // Waning (15-29) - light on left side, shrinking
                moonCircle.style.background = 'linear-gradient(90deg, #f8f9fa 50%, #2c3e50 50%)';
                moonOverlay.className = 'moon-overlay left';
                moonOverlay.style.display = 'block';

                const scale = Math.abs(Math.cos(phase * Math.PI * 2));
                moonOverlay.style.transform = `scaleX(${scale})`;
                moonOverlay.style.background = phaseDay < 22 ? '#f8f9fa' : '#2c3e50';
            }
        }

        function updateSunArc(sunData) {
            const sunrise = sunData.sunrise ? new Date(sunData.sunrise) : null;
            const solarNoon = sunData.solar_noon ? new Date(sunData.solar_noon) : null;
            const sunset = sunData.sunset ? new Date(sunData.sunset) : null;

            // Always use current time in the correct timezone for real-time updates
            const now = currentTimezone ?
                new Date(new Date().toLocaleString('en-US', { timeZone: currentTimezone })) :
                new Date();

            // Update legend times
            document.getElementById('arc-sunrise-time').textContent = formatTime(sunData.sunrise);
            document.getElementById('arc-noon-time').textContent = formatTime(sunData.solar_noon);
            document.getElementById('arc-sunset-time').textContent = formatTime(sunData.sunset);

            if (!sunrise || !sunset || !solarNoon) {
                // Polar day/night - hide sun position or show edge case
                const sunPosition = document.getElementById('sun-position');
                sunPosition.style.opacity = '0.3';
                return;
            }

            const sunPosition = document.getElementById('sun-position');
            sunPosition.style.opacity = '1';

            const nowTime = now.getTime();
            const sunriseTime = sunrise.getTime();
            const sunsetTime = sunset.getTime();

            // Calculate position along the arc (0 = sunrise, 0.5 = noon, 1 = sunset)
            let progress;
            if (nowTime < sunriseTime) {
                // Before sunrise - sun below horizon on left
                progress = -0.1;
            } else if (nowTime > sunsetTime) {
                // After sunset - sun below horizon on right
                progress = 1.1;
            } else {
                // During daylight - calculate position along arc
                progress = (nowTime - sunriseTime) / (sunsetTime - sunriseTime);
            }

            // Convert progress to position on the semicircle arc
            // Arc goes from (20, 150) through (200, 20) to (380, 150)
            // Using quadratic Bezier curve: P(t) = (1-t)²P₀ + 2(1-t)tP₁ + t²P₂
            const t = progress;
            const x = Math.pow(1 - t, 2) * 20 + 2 * (1 - t) * t * 200 + Math.pow(t, 2) * 380;
            const y = Math.pow(1 - t, 2) * 150 + 2 * (1 - t) * t * 20 + Math.pow(t, 2) * 150;

            // Update sun position
            const circle = sunPosition.querySelector('circle');
            const label = sunPosition.querySelector('text');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            label.setAttribute('x', x);
            label.setAttribute('y', y + 20);

            // Update label to show if sun is below horizon
            if (progress < 0 || progress > 1) {
                label.textContent = 'Below Horizon';
                circle.style.opacity = '0.4';
            } else {
                label.textContent = 'Now';
                circle.style.opacity = '1';
            }
        }

        function displayLinks(links) {
            if (!links.length) {
                linksContainer.innerHTML = `
                    <div class="link-card">
                        <div class="link-name">No links available</div>
                    </div>
                `;
                return;
            }

            linksContainer.innerHTML = '';
            links.forEach((link) => {
                const linkCard = document.createElement('div');
                linkCard.className = 'link-card';
                linkCard.innerHTML = `
                    <div class="link-icon">
                        <i class="${link.icon || 'fas fa-link'}"></i>
                    </div>
                    <div class="link-name">${link.name}</div>
                    <a href="${link.url}" class="link-url" target="_blank" rel="noopener">${link.url}</a>
                `;
                linksContainer.appendChild(linkCard);
            });
        }

        function formatTime(dateTimeStr) {
            if (!dateTimeStr) {
                return 'N/A';
            }
            const parsed = new Date(dateTimeStr);
            if (Number.isNaN(parsed.getTime())) {
                return 'N/A';
            }
            return parsed.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatDate(dateStr) {
            if (!dateStr) {
                return 'N/A';
            }
            const parsed = new Date(dateStr);
            if (Number.isNaN(parsed.getTime())) {
                return 'N/A';
            }
            return parsed.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatDayLength(seconds) {
            if (seconds === null || seconds === undefined) {
                return 'N/A';
            }
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes.toString().padStart(2, '0')}m`;
        }

        function showError(message) {
            errorContainer.innerHTML = `
                <div class="error">
                    <i class="fas fa-exclamation-circle"></i> ${message}
                </div>
            `;
        }

        function formatCoordinate(value, type) {
            if (typeof value !== 'number' || Number.isNaN(value)) {
                return 'N/A';
            }
            const abs = Math.abs(value).toFixed(4);
            const direction = type === 'lat'
                ? value >= 0 ? 'N' : 'S'
                : value >= 0 ? 'E' : 'W';
            return `${abs}° ${direction}`;
        }

        function formatManualLocationText() {
            const latValue = parseFloat(document.getElementById('latitude').value);
            const lonValue = parseFloat(document.getElementById('longitude').value);
            if (Number.isNaN(latValue) || Number.isNaN(lonValue)) {
                return 'Manual coordinates not set';
            }
            return `Manual coordinates (${formatCoordinate(latValue, 'lat')}, ${formatCoordinate(lonValue, 'lon')})`;
        }

        async function fetchWeatherData() {
            const latValue = parseFloat(document.getElementById('latitude').value);
            const lonValue = parseFloat(document.getElementById('longitude').value);

            if (Number.isNaN(latValue) || Number.isNaN(lonValue)) {
                console.warn('Invalid coordinates for weather fetch');
                return;
            }

            try {
                const params = new URLSearchParams({
                    lat: latValue.toString(),
                    lon: lonValue.toString(),
                    days: '3', // Request 3-day forecast
                });

                const response = await fetch(`/weather?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`Weather request failed with status ${response.status}`);
                }

                const data = await response.json();
                updateWeatherDisplay(data);
                lastWeatherUpdate = Date.now(); // Track when weather data was updated
            } catch (error) {
                console.error('Failed to fetch weather data', error);
                // Show error in weather card but don't block the rest of the dashboard
                document.getElementById('weather-condition').textContent = 'Unable to load weather';
            }
        }

        function updateWeatherDisplay(data) {
            // Display both Celsius and Fahrenheit
            const windUnit = ' km/h';

            document.getElementById('temperature').textContent = `${Math.round(data.current.temp_c)}°C (${Math.round(data.current.temp_f)}°F)`;
            document.getElementById('feels-like').textContent = `${Math.round(data.current.feels_like_c)}°C (${Math.round(data.current.feels_like_f)}°F)`;
            document.getElementById('weather-condition').textContent = data.current.condition.text;

            // Set weather icon (add https: prefix if missing)
            const iconUrl = data.current.condition.icon.startsWith('//')
                ? `https:${data.current.condition.icon}`
                : data.current.condition.icon;
            document.getElementById('weather-icon').src = iconUrl;

            // Calculate wind conversions
            const windKph = Math.round(data.current.wind_kph);
            const windMph = Math.round(data.current.wind_mph);
            const windKnots = Math.round(data.current.wind_kph * 0.539957);

            // Calculate pressure in inHg (1 mb = 0.02953 inHg)
            const pressureMb = Math.round(data.current.pressure_mb);
            const pressureInHg = (data.current.pressure_mb * 0.02953).toFixed(2);

            document.getElementById('humidity').textContent = `${data.current.humidity}%`;

            const windEl = document.getElementById('wind');
            windEl.textContent = `${windKph}${windUnit} ${data.current.wind_dir}`;
            windEl.title = `Wind: ${windKph} km/h • ${windMph} mph • ${windKnots} knots`;

            const pressureEl = document.getElementById('pressure');
            pressureEl.textContent = `${pressureMb} mb`;
            pressureEl.title = `Pressure: ${pressureMb} mb • ${pressureInHg} inHg`;

            document.getElementById('precipitation').textContent = `${data.current.precip_mm} mm`;
            document.getElementById('uv-index').textContent = data.current.uv;

            // Update forecast if available
            if (data.forecast && data.forecast.days && data.forecast.days.length > 0) {
                updateForecastDisplay(data.forecast.days);
                document.getElementById('weather-forecast').style.display = 'block';
            } else {
                document.getElementById('weather-forecast').style.display = 'none';
            }
        }

        function updateForecastDisplay(forecastDays) {
            const forecastContainer = document.getElementById('forecast-days');
            forecastContainer.innerHTML = '';

            forecastDays.forEach((day, index) => {
                const date = new Date(day.date);
                const dayName = index === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short' });
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                const iconUrl = day.condition.icon.startsWith('//')
                    ? `https:${day.condition.icon}`
                    : day.condition.icon;

                // Calculate wind in mph and knots
                const windMph = Math.round(day.max_wind_mph);
                const windKnots = Math.round(day.max_wind_kph * 0.539957);

                const forecastCard = document.createElement('div');
                forecastCard.className = 'forecast-day';
                forecastCard.innerHTML = `
                    <div class="forecast-date">${dayName}<br>${dateStr}</div>
                    <div class="forecast-icon">
                        <img src="${iconUrl}" alt="${day.condition.text}">
                    </div>
                    <div class="forecast-temp" title="Average temperature">${Math.round(day.avg_temp_c)}°C (${Math.round(day.avg_temp_f)}°F)</div>
                    <div class="forecast-temp-range">
                        <i class="fas fa-arrow-up" style="color: #dc3545;" title="High temperature"></i> ${Math.round(day.max_temp_c)}°C
                        <i class="fas fa-arrow-down" style="color: #4a6fa5;" title="Low temperature"></i> ${Math.round(day.min_temp_c)}°C
                    </div>
                    <div class="forecast-condition">${day.condition.text}</div>
                    <div class="forecast-detail">
                        <div class="forecast-detail-item" title="Average humidity">
                            <i class="fas fa-tint"></i>
                            <span>${day.avg_humidity}%</span>
                        </div>
                        <div class="forecast-detail-item" title="Chance of rain">
                            <i class="fas fa-cloud-rain"></i>
                            <span>${day.daily_chance_of_rain}%</span>
                        </div>
                        <div class="forecast-detail-item" title="Max wind: ${Math.round(day.max_wind_kph)} km/h • ${windMph} mph • ${windKnots} knots">
                            <i class="fas fa-wind"></i>
                            <span>${Math.round(day.max_wind_kph)}</span>
                        </div>
                    </div>
                `;
                forecastContainer.appendChild(forecastCard);
            });
        }

        function startWeatherRefresh() {
            if (weatherRefreshTimer) {
                clearInterval(weatherRefreshTimer);
            }
            weatherRefreshTimer = setInterval(() => {
                console.log('Auto-refreshing weather data');
                fetchWeatherData();
            }, WEATHER_REFRESH_MS);
        }
    </script>
</body>
</html>
